app=angular.module("Equisym",["ngMaterial","ngMessages","ngSanitize","ngCsv","nvd3","pascalprecht.translate","ngStorage","appConfig","MainCtrl"]),angular.module("appConfig",[]).config(["$mdThemingProvider","$mdIconProvider","$mdThemingProvider","$translateProvider",function(a,t,a,e){iconp=t.defaultFontSet("fas"),angular.forEach({"md-plus":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',"md-close":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',"md-arrow-back":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>',"md-apps":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><g transform="translate(3, 3)"><circle cx="2" cy="2" r="2"></circle><circle cx="2" cy="9" r="2"></circle><circle cx="2" cy="16" r="2"></circle><circle cx="9" cy="2" r="2"></circle><circle cx="9" cy="9" r="2"></circle><circle cx="16" cy="2" r="2"></circle><circle cx="16" cy="9" r="2"></circle><circle cx="16" cy="16" r="2"></circle><circle cx="9" cy="16" r="2"></circle></g></svg>',"md-enter":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M11 5v5.59H7.5l4.5 4.5 4.5-4.5H13V5h-2zm-5 9c0 3.31 2.69 6 6 6s6-2.69 6-6h-2c0 2.21-1.79 4-4 4s-4-1.79-4-4H6z"/></svg>',"md-save":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>',"md-delete":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',"md-bars":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>',"md-more-v":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>',"md-search":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',"md-chevron-down":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',"md-check":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',"md-edit":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',"md-settings":'<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>'},function(a,t){iconp.icon(t,"data:image/svg+xml, "+a,24)}),a.definePalette("DorrAssetPallete",{50:"f4f5ec",100:"e4e7d1",200:"d2d7b2",300:"c0c793",400:"b3bb7b",500:"a5af64",600:"9da85c",700:"939f52",800:"8a9648",900:"798636",A100:"f8ffd4",A200:"efffa1",A400:"e6ff6e",A700:"e1ff54",contrastDefaultColor:"light",contrastDarkColors:["50","100","200","300","400","500","600","700","800","A100","A200","A400","A700"],contrastLightColors:["900"]}),a.theme("default").primaryPalette("DorrAssetPallete");var r={en:{APP_NAME:"Equity Curve Simulator",PARAMETERS:"Parámeters",STARTING_EQ:"Starting Equity",RISK_PER_TRADE:"Risk per Trade",WIN_PROB:"Win Probability",WIN_LOSS_REL:"Win:Loss Relation",TRADES_PER_RUN:"Trades per Run",RUNS_LINES:"Scenarios (Lines)",GRAPH_SCALE:"Graph Scale",RUN_SIMULATION:"Run Simulation",GRAPH:"Graph",TRADE:"Trade",EQ:"Equity",MAX:"Maximum",MIN:"Minimum",AVG:"Average",RESULTS:"Results",KELLY:"Kelly",EXPECTATION:"Expectation",MAX_DRAWDOWN:"Max. Drawdown",AVG_MAX_DRAWDOWN:"Avg. Max Drawdown",MIN_EQ:"Min. Equity",MAX_EQ:"Max. Equity",MAX_CONSEC_WINS:"Max. Consecutive Wins",MAX_CONSEC_LOSES:"Max. Consecutive Loses",AVG_PERFORMANCE:"Avg. Performance",RETURN_MAX_DRAWDOWN:"Return on Max Drawdown",DOWNLOAD_DATA:"Download Data",GOT_IT:"Got It",H_KELLY:"Kelly is this.."},es:{APP_NAME:"Simulador de Curva de Capital",PARAMETERS:"Parámetros",STARTING_EQ:"Capital Inicial",RISK_PER_TRADE:"Riesgo por Transacción",WIN_PROB:"Probabilidad de Ganar",WIN_LOSS_REL:"Relación Ganancia:Pérdida",TRADES_PER_RUN:"Transacciones por Escenario",RUNS_LINES:"Escenarios (Lineas)",GRAPH_SCALE:"Escala de la Gráfica",RUN_SIMULATION:"Correr Simulación",GRAPH:"Gráfica",TRADE:"Transacción",EQ:"Capital",MAX:"Máximo",MIN:"Mínimo",AVG:"Promedio",RESULTS:"Resultados",KELLY:"Criterio Kelly",EXPECTATION:"Expectativa",MAX_DRAWDOWN:"Reducción Máx.",AVG_MAX_DRAWDOWN:"Reducción Máx. Prom.",MIN_EQ:"Capital Min.",MAX_EQ:"Capital Max.",MAX_CONSEC_WINS:"Ganancias Consecutivas Máx.",MAX_CONSEC_LOSES:"Perdidas Consecutivas Máx.",AVG_PERFORMANCE:"Desempeño Prom.",RETURN_MAX_DRAWDOWN:"Retorno en Reducción Máx.",DOWNLOAD_DATA:"Descargar Datos",GOT_IT:"Entendido",H_KELLY:"El Criterio Kelly consiste en"}};e.useSanitizeValueStrategy("escape").translations("en",r.en).translations("es",r.es).preferredLanguage("en")}]),angular.module("MainCtrl",[]).controller("MainCtrl",["$scope","$rootScope","$timeout","$translate","$mdDialog","$localStorage","$window",function(a,t,e,r,n,s,l){Rs=a;var o={},d=r.instant;Rs.Inputs={currencySymbol:"$",startingEq:100,winProb:50,winRatio:2,trades:100,runs:10,risk:1,riskType:"Percent",scale:"Normal",calculating:!1,calcDone:!1},o.Control={},o.gamble=(()=>{return Math.floor(100*Math.random())<Rs.Inputs.winProb}),o.getRiskedVal=(a=>{if(a<=0)return 0;var t="Percent"==Rs.Inputs.riskType?a*Rs.Inputs.risk/100:Math.min(Rs.Inputs.risk,a);return t=Math.min(t,a)}),o.calcEq=((a,t,e)=>{if(a<=0)return 0;var r=t*Rs.Inputs.winRatio,n=e?a+r:a-t;return n=Math.max(n,0),o.actRun.eq=n}),o.trade=(()=>{1==o.Control.currentTrade&&(o.actRun={run:o.Control.currentRun,eq:angular.copy(Rs.Inputs.startingEq),maxEq:0,maxDD:0,maxDDAbs:0,trades:[]},o.Control.CW=0,o.Control.CL=0);var a=o.gamble(),t=o.getRiskedVal(o.actRun.eq),e={run:o.Control.currentRun,trade:o.Control.currentTrade,tradeGlob:o.Control.currentTradeGlob,risked:t,win:a,eq:o.calcEq(o.actRun.eq,t,a),cw:o.Control.CW,cl:o.Control.CL};o.actRun.maxEq=Math.max(o.actRun.maxEq,e.eq),e.dd=(o.actRun.maxEq-e.eq)/o.actRun.maxEq,e.dd>o.actRun.maxDD&&(o.actRun.maxDD=e.dd,o.actRun.maxDDAbs=e.dd*o.actRun.maxEq),o.actRun.trades.push(e),o.Control.currentTradeGlob++,a?(o.Control.CW++,o.Control.CL=0):(o.Control.CL++,o.Control.CW=0),o.Control.currentTrade>=Rs.Inputs.trades?(o.Results.push(o.actRun),o.Control.currentTrade=1,o.Control.currentRun++):o.Control.currentTrade++,o.Control.currentTradeGlob<=o.Control.totalTrades||(console.log("Termine"),o.finishCalc())}),Rs.run=(()=>{Rs.Inputs.calculating||(Rs.reset(),Rs.Inputs.calculating=!0,Rs.Inputs.calcDone=!1,Rs.chartData=[],console.log("Starting"),e(()=>{for(var a=1;a<=o.Control.totalTrades;a++)o.trade()},1500))}),Rs.reset=(()=>{o.Results=[],o.Control={},o.Control.currentRun=1,o.Control.currentTrade=1,o.Control.currentTradeGlob=1,o.Control.totalTrades=Rs.Inputs.runs*Rs.Inputs.trades,o.Control.CW=0,o.Control.CL=0,o.Control.chartFixed=!1}),o.finishCalc=(()=>{var a=[];o.TData=[],o.Results.forEach(t=>{var e={key:"Run #"+t.run,strokeWidth:.5,values:[{x:0,y:Rs.Inputs.startingEq}]};t.trades.forEach(a=>{e.values.push({x:a.trade,y:a.eq}),1==t.run&&o.TData.push({sum:0,min:a.eq,max:a.eq}),TD=o.TData[a.trade-1],TD.sum+=a.eq,TD.min=Math.min(TD.min,a.eq),TD.max=Math.max(TD.max,a.eq),1==a.tradeGlob?(o.Control.minEq=a.eq,o.Control.maxEq=a.eq,o.Control.maxCW=0,o.Control.maxCL=0):(o.Control.minEq=Math.min(o.Control.minEq,a.eq),o.Control.maxEq=Math.max(o.Control.maxEq,a.eq),o.Control.maxCW=Math.max(o.Control.maxCW,a.cw),o.Control.maxCL=Math.max(o.Control.maxCL,a.cl))}),a.push(e)});var t=[{x:0,y:Rs.Inputs.startingEq,size:5}],e=[];o.Control.maxTAvg=0,o.TData.forEach((a,r)=>{a.avg=a.sum/Rs.Inputs.runs,t.push({x:r+1,y:a.avg,size:70}),e.push({x:r+1,y:Rs.Inputs.startingEq}),o.Control.lastTAvg=a.avg,o.Control.maxTAvg=Math.max(o.Control.maxTAvg,a.avg)}),a.push({key:"Average",strokeWidth:3,color:"black",values:t}),o.calcVars(),Rs.chartData=a,Rs.Inputs.calculating=!1,Rs.Inputs.calcDone=!0}),o.calcVars=(()=>{Rs.Vars=v={},i=Rs.Inputs,c=o.Control,v.Accuracy=i.winProb/100,v.PayOff=i.winRatio,v.Kelly=d3.format(",.2f")(v.Accuracy-(1-v.Accuracy)/v.PayOff),v.Expectation=d3.format(",.2f")(v.Accuracy*v.PayOff-(1-v.Accuracy)),v.minEq=d3.format(",.2f")(c.minEq),v.maxEq=d3.format(",.2f")(c.maxEq),v.maxCW=d3.format(",.0f")(c.maxCW),v.maxCL=d3.format(",.0f")(c.maxCL),v.avgMaxDD=0,v.maxDD=0,v.maxDDAbs=0,o.Results.forEach(a=>{v.avgMaxDD+=a.maxDD,v.maxDD=Math.max(v.maxDD,a.maxDD),v.maxDDAbs=Math.max(v.maxDDAbs,a.maxDDAbs)}),v.maxDD=d3.format(",.2%")(v.maxDD),v.maxDDAbs=d3.format(",.2f")(v.maxDDAbs),v.avgMaxDDRaw=v.avgMaxDD/i.runs,v.avgMaxDD=d3.format(",.2%")(v.avgMaxDDRaw),v.avgPerfAbs=d3.format(",.2f")(c.lastTAvg-i.startingEq),v.avgPerf=d3.format(",.2%")(+v.avgPerfAbs/i.startingEq),v.retMaxDD=d3.format(",.2%")((c.lastTAvg-(c.maxTAvg-v.avgMaxDDRaw))/(c.maxTAvg-v.avgMaxDDRaw)),Rs.Vars=v}),Rs.chartOps={chart:{type:"lineChart",height:500,margin:{top:10,right:20,bottom:40,left:55},pointSize:a=>a.size||4,pointShape:a=>a.shape||"circle",x:function(a){return a.x},y:function(a){if(a)return a.y},noData:"No Data",useInteractiveGuideline:!0,showLegend:!1,xAxis:{axisLabel:""},yAxis:{axisLabel:"",tickFormat:function(a){return d3.format(",.0f")(a)},axisLabelDistance:-10},color:["#88A80B","#BCDA45","#A7CB1B","#6F8B00","#526700","#579E0A","#8ACD41","#70BF19","#448300","#326100","#AFAA0B","#E3DE48","#D4CE1C","#918C00","#6B6800"],interpolate:"monotone",interactiveLayer:{showGuideLine:!0,tooltip:{contentGenerator:a=>{if(null===a||0==a.value)return"";TD=o.TData[a.value-1];var t="<table><thead><tr><td class=x-value colspan=2><span class='tooltip text-bold text-green'>"+d("TRADE")+" #"+a.value+"</span></td></tr></thead><tbody>";return t+="<tr><td class=key>"+d("AVG")+":</td><td class=value>"+d3.format(",.2f")(TD.avg)+"<td><tr>",t+="<tr><td class=key>"+d("MAX")+":</td><td class=value>"+d3.format(",.2f")(TD.max)+"<td><tr>",t+="<tr><td class=key>"+d("MIN")+":</td><td class=value>"+d3.format(",.2f")(TD.min)+"<td><tr>",t+="</tbody></table>"}}},dispatch:{renderEnd:function(a){o.fixChart()}}}},o.fixChart=(()=>{o.Control.chartFixed||(window.dispatchEvent(new Event("resize")),o.Control.chartFixed=!0)});var h=window.innerHeight-110;h=Math.min(h,500),Rs.chartOps.chart.height=h,Rs.chartConfig={deepWatchData:!1,deepWatchDataDepth:0},Rs.run(),Rs.CSVHeaders=["Run","Trade","Win","Equity"],Rs.getCSV=(()=>{var a=[];return o.Results.forEach(t=>{t.trades.forEach(e=>{a.push([t.run,e.trade,e.win,d3.format(".2f")(e.eq)])})}),a}),Rs.IndHelp=((a,t)=>{n.show(n.alert().clickOutsideToClose(!0).targetEvent(a).fullscreen(!1).title(d(t)).textContent(d("H_"+t)).ok(d("GOT_IT")))}),Rs.Languages=[{id:"en",name:"English"},{id:"es",name:"Español"}];var u=l.navigator.language||l.navigator.userLanguage;u?(u=u.substring(0,2),-1==["en","es"].indexOf(u)&&(u="en")):u="en",Rs.Storage=s.$default({Lang:u}),Rs.changeLang=(()=>{r.use(Rs.Storage.Lang),Rs.chartOps.chart.xAxis.axisLabel=d("TRADE")+" #",Rs.chartOps.chart.yAxis.axisLabel=d("EQ")+" ("+Rs.Inputs.currencySymbol+")"}),Rs.changeLang()}]);